```{r}
setwd("peakcalling")
source("../sure-snp_functions.r")

library(DESeq2)

count.matrix           <- fread("data/SuRE-SNP_CeD_x3_filtered.countMatrix", data.table = F)
rownames(count.matrix) <- count.matrix[,1]
count.matrix           <- count.matrix[,-1]
meta.data              <- read.table("data/SuRE-SNP_CeD_x3_filtered.samplesheet", stringsAsFactors = F, header=T)
row.names(meta.data)   <- meta.data$id

deseq.full             <- DESeqDataSetFromMatrix(countData = count.matrix,
                                     colData = meta.data[colnames(count.matrix),],
                                     design = ~ celltype + replicate + stimulation)



```

# PCA & correlations analysis of peaks: VST
```{r}
results <- DESeq(deseq.full)
# VST
pca.obj <- varianceStabilizingTransformation(results)
x       <- assay(pca.obj)

# PCA plot
pdf(file="output/plots/pca_of_vst_normalized_peaks.pdf", width=6, height=5, paper="a4")
pc      <- prcomp(t(x))
pca.plot(pc,
         color=meta.data$stimulation,
         shape=meta.data$celltype, size = 4)
dev.off()

# Correlation heatmap
palette        <- sure.palette[c("celltype", "stimulation")]
names(palette) <- c("celltype", "simple_stimulation")
cor.m          <- cor(x)

pdf(file="output/plots/correlation_heatmap_of_vst_normalized_peaks.pdf", width=6, height=5, paper="a4")
simple.hm(cor.m, 
          range="absolute",
          annotation_row=meta.data[,c("celltype", "simple_stimulation")],
          annotation_colors=palette,
          min.value = 0.7,
          fontsize=8,
          cellwidth = 8.5,
          cellheight = 8.5,
          border_color=NA,
          treeheight_row=20,
          treeheight_col=20)
dev.off()
```

# PCA & correlations analysis of peaks: log2(TPM)
```{r}
# Verify from raw counts using TPM normalization
peak.lengths <- unlist(lapply(strsplit(gsub(".*\\:", "", rownames(count.matrix)), "-"),
                              function(x){return(as.numeric(x[2]) - as.numeric(x[1]))})) / 1000

norm.count.matrix <- count.matrix / peak.lengths
scale.factor      <- colSums(norm.count.matrix) / 1e6
norm.count.matrix <- t(apply(norm.count.matrix, 1, function(x){x / scale.factor}))

# PCA plot
pc      <- prcomp(t(log2(norm.count.matrix)))
pca.plot(pc,
         color=meta.data$stimulation,
         shape=meta.data$celltype, size = 4)

# Correlation plot
cor.m             <- cor(log2(norm.count.matrix))
simple.hm(cor.m, range="absolute",
          annotation_row=meta.data[,c("celltype", "simple_stimulation")],
          annotation_colors=palette)
```

# Celltype: DE analysis
```{r}
k.c.res   <- results(results, contrast=c("stimulation", "c-baseline", "k-baseline"), lfcThreshold = 1)
k.c.res   <- as.data.frame(k.c.res)

k.j.res   <- results(results, contrast=c("stimulation", "j-baseline", "k-baseline"), lfcThreshold = 1)
k.j.res   <- as.data.frame(k.c.res)
```

# Stimulation: DE analysis
```{r}
jurkat.res   <- results(results, contrast=c("stimulation", "acd3/acd28", "j-baseline"), lfcThreshold = 1)
jurkat.res   <- as.data.frame(jurkat.res)

caco.res   <- results(results, contrast=c("stimulation", "iFNY", "c-baseline"), lfcThreshold = 1)
caco.res   <- as.data.frame(caco.res)
```

